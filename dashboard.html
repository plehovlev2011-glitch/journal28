<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            cursor: pointer;
        }
        .card { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        .loading { color: gray; font-style: italic; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üìö –ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫</h1>
    
    <div id="userInfo" class="card">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
    </div>
    
    <div>
        <button onclick="loadMarks()">–ó–ê–ì–†–£–ó–ò–¢–¨ –û–¶–ï–ù–ö–ò</button>
        <button onclick="loadSubjects()">–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–†–ï–î–ú–ï–¢–´</button>
        <button onclick="logout()">–í–´–ô–¢–ò</button>
    </div>
    
    <div id="marksContent" class="card">
        –û—Ü–µ–Ω–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
    </div>
    
    <div id="subjectsContent" class="card">
        –ü—Ä–µ–¥–º–µ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ—à–ª–∏ –ª–∏ –º—ã
        window.onload = function() {
            const studentId = localStorage.getItem('studentId');
            const username = localStorage.getItem('username');
            
            if (!studentId || !username) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!");
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userInfo').innerHTML = `
                –£—á–µ–Ω–∏–∫: <strong>${username}</strong><br>
                ID: <strong>${studentId}</strong><br>
                –ö–ª–∞—Å—Å: <strong>${localStorage.getItem('classId') || '1000'}</strong>
            `;
        };
        
        async function loadMarks() {
            const container = document.getElementById('marksContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...</span>';
            
            try {
                const studentId = localStorage.getItem('studentId');
                const classId = localStorage.getItem('classId');
                
                // –ó–∞–ø—Ä–æ—Å –∫ API
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'GET_STUDENT_MARKS',
                        student: parseInt(studentId),
                        uchYear: 2025,
                        cls: parseInt(classId)
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    container.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${data.error}</span>`;
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                const marks = data.data || [];
                
                if (marks.length === 0) {
                    container.innerHTML = "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫";
                    return;
                }
                
                let html = "<h3>–û—Ü–µ–Ω–∫–∏:</h3>";
                marks.forEach(item => {
                    html += `<div><strong>${item.subject || '–ü—Ä–µ–¥–º–µ—Ç'}</strong>: ${item.marks_154 || item.marks_262 || '–Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫'}</div>`;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        async function loadSubjects() {
            const container = document.getElementById('subjectsContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...</span>';
            
            try {
                const studentId = localStorage.getItem('studentId');
                const classId = localStorage.getItem('classId');
                
                // –ó–∞–ø—Ä–æ—Å –∫ API
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'GET_STUDENT_SUBJECTS',
                        student: parseInt(studentId),
                        uchYear: 2025,
                        cls: parseInt(classId)
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    container.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${data.error}</span>`;
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
                const subjects = data.data || [];
                
                if (subjects.length === 0) {
                    container.innerHTML = "–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤";
                    return;
                }
                
                let html = "<h3>–ü—Ä–µ–¥–º–µ—Ç—ã:</h3>";
                subjects.forEach(subject => {
                    if (Array.isArray(subject) && subject[1]) {
                        html += `<div>${subject[1]}</div>`;
                    }
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
