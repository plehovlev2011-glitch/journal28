<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ - –®–∫–æ–ª–∞ 28</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            margin: 20px 0 10px 0;
            color: #2c3e50;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .error {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
        }
        .success {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: monospace;
        }
        button:hover {
            background: #2980b9;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .debug {
            background: #f9f9f9;
            border-left: 3px solid #95a5a6;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
        .marks {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .mark {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ecf0f1;
            border-radius: 4px;
            font-weight: bold;
        }
        .mark.good { background: #2ecc71; color: white; }
        .mark.bad { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –î–ê–®–ë–û–†–î (–æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º)</h1>
        
        <!-- –ò–Ω—Ñ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="card">
            <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
            <div id="userInfo" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="card">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h3>
            <button onclick="loadMarks()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
            <button onclick="loadSubjects()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</button>
            <button onclick="loadMessages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
            <button onclick="testProxy()">–¢–µ—Å—Ç –ø—Ä–æ–∫—Å–∏</button>
            <button onclick="logout()" style="background: #e74c3c;">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card">
            <h3>üêõ –û—Ç–ª–∞–¥–∫–∞:</h3>
            <div id="debugInfo" class="debug">
                –ö–æ–Ω—Å–æ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞? –ù–∞–∂–º–∏ F12
            </div>
            <button onclick="showLocalStorage()">–ü–æ–∫–∞–∑–∞—Ç—å localStorage</button>
            <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
        
        <!-- –û—Ü–µ–Ω–∫–∏ -->
        <div class="card">
            <h3>üìà –û—Ü–µ–Ω–∫–∏:</h3>
            <div id="marksContent" class="loading">
                –ù–∞–∂–º–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ü–µ–Ω–∫–∏"
            </div>
        </div>
        
        <!-- –ü—Ä–µ–¥–º–µ—Ç—ã -->
        <div class="card">
            <h3>üìö –ü—Ä–µ–¥–º–µ—Ç—ã:</h3>
            <div id="subjectsContent" class="loading">
                –ù–∞–∂–º–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã"
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="card">
            <h3>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è:</h3>
            <div id="messagesContent" class="loading">
                –ù–∞–∂–º–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"
            </div>
        </div>
        
        <!-- –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ -->
        <div class="card">
            <h3>üìÑ –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å):</h3>
            <div id="rawData" class="debug">
                –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
            </div>
        </div>
    </div>

    <script>
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let studentId = null;
        let classId = null;
        let username = null;
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω');
            updateDebug('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            studentId = localStorage.getItem('studentId');
            classId = localStorage.getItem('classId');
            username = localStorage.getItem('username');
            
            console.log('üìã –î–∞–Ω–Ω—ã–µ –∏–∑ localStorage:', { studentId, classId, username });
            
            if (!studentId || !username) {
                updateDebug('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updateUserInfo();
            updateDebug('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        });
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–§–û ====================
        function updateUserInfo() {
            const info = `
                –£—á–µ–Ω–∏–∫: <strong>${username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong><br>
                ID —É—á–µ–Ω–∏–∫–∞: <strong>${studentId || '–ù–µ—Ç'}</strong><br>
                –ö–ª–∞—Å—Å: <strong>${classId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong><br>
                –í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}
            `;
            document.getElementById('userInfo').innerHTML = info;
        }
        
        // ==================== API –ó–ê–ü–†–û–°–´ ====================
        async function fetchAvers(action, params = {}) {
            console.group(`üì§ API –∑–∞–ø—Ä–æ—Å: ${action}`);
            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', params);
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                const requestData = {
                    action: action,
                    student: parseInt(studentId) || 0,
                    uchYear: 2025,
                    cls: parseInt(classId) || 0,
                    ...params
                };
                
                console.log('–ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å:', requestData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç –æ—Ç –ø—Ä–æ–∫—Å–∏:', data);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                document.getElementById('rawData').textContent = 
                    JSON.stringify(data, null, 2).substring(0, 1000) + '...';
                
                console.groupEnd();
                return data.data || data;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
                console.groupEnd();
                
                document.getElementById('rawData').textContent = 
                    `–û—à–∏–±–∫–∞: ${error.message}`;
                
                throw error;
            }
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –û–¶–ï–ù–û–ö ====================
        async function loadMarks() {
            updateDebug('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...');
            const container = document.getElementById('marksContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            
            try {
                const marks = await fetchAvers('GET_STUDENT_MARKS');
                console.log('üìä –û—Ü–µ–Ω–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã:', marks);
                
                if (!marks || marks.length === 0) {
                    container.innerHTML = '<div class="error">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</div>';
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                let html = '';
                marks.forEach((item, index) => {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                    const marksHtml = item.marks_154 || item.marks_262 || '';
                    const cleanMarks = extractMarks(marksHtml);
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${index + 1}. ${item.subject || '–ü—Ä–µ–¥–º–µ—Ç'}</strong><br>
                            <small>–£—á–∏—Ç–µ–ª—å: ${item.teacher || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small>
                            <div class="marks">
                                ${cleanMarks.map(mark => {
                                    const num = parseFloat(mark);
                                    let className = 'mark';
                                    if (!isNaN(num)) {
                                        if (num >= 4.5) className += ' good';
                                        else if (num <= 2.5) className += ' bad';
                                    }
                                    return `<span class="${className}">${mark}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateDebug('‚úÖ –û—Ü–µ–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫:', error);
                container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                updateDebug(`‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–æ–∫: ${error.message}`);
            }
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –ü–†–ï–î–ú–ï–¢–û–í ====================
        async function loadSubjects() {
            updateDebug('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...');
            const container = document.getElementById('subjectsContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            
            try {
                const subjects = await fetchAvers('GET_STUDENT_SUBJECTS');
                console.log('üìö –ü—Ä–µ–¥–º–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã:', subjects);
                
                if (!subjects || subjects.length === 0) {
                    container.innerHTML = '<div class="error">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
                let html = '<ul>';
                subjects.forEach(subject => {
                    if (Array.isArray(subject) && subject[1]) {
                        html += `<li><strong>${subject[1]}</strong> (ID: ${subject[0]})</li>`;
                    }
                });
                html += '</ul>';
                
                container.innerHTML = html;
                updateDebug('‚úÖ –ü—Ä–µ–¥–º–µ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', error);
                container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                updateDebug(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ${error.message}`);
            }
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================
        async function loadMessages() {
            updateDebug('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...');
            const container = document.getElementById('messagesContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            
            try {
                const messages = await fetchAvers('GET_STUDENT_MESSAGES');
                console.log('üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã:', messages);
                
                if (!messages || messages.length === 0) {
                    container.innerHTML = '<div class="success">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                let html = '';
                messages.forEach(msg => {
                    const date = msg.dateWhen ? new Date(msg.dateWhen).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9;">
                            <strong>${date}</strong><br>
                            ${msg.message || '–°–æ–æ–±—â–µ–Ω–∏–µ'}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateDebug('‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                updateDebug(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: ${error.message}`);
            }
        }
        
        // ==================== –¢–ï–°–¢ –ü–†–û–ö–°–ò ====================
        async function testProxy() {
            updateDebug('üß™ –¢–µ—Å—Ç –ø—Ä–æ–∫—Å–∏...');
            
            try {
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'ping',
                        test: 'hello'
                    })
                });
                
                const data = await response.json();
                console.log('–¢–µ—Å—Ç –ø—Ä–æ–∫—Å–∏:', data);
                
                updateDebug(`‚úÖ –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${response.status}`);
                alert(`–ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! –°—Ç–∞—Ç—É—Å: ${response.status}`);
                
            } catch (error) {
                console.error('–¢–µ—Å—Ç –ø—Ä–æ–∫—Å–∏ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è:', error);
                updateDebug(`‚ùå –ü—Ä–æ–∫—Å–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ${error.message}`);
                alert('–ü—Ä–æ–∫—Å–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + error.message);
            }
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function extractMarks(htmlString) {
            if (!htmlString) return [];
            
            return htmlString
                .replace(/<[^>]*>/g, '')
                .replace(/&nbsp;/g, ' ')
                .replace(/\([^)]*\)/g, '')
                .trim()
                .split(/\s+/)
                .filter(m => m && m.length < 4 && m !== '...')
                .map(m => m.replace(/[^0-9./–£–ë–ù]/g, ''));
        }
        
        function updateDebug(message) {
            const now = new Date().toLocaleTimeString();
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `[${now}] ${message}<br>` + debugDiv.innerHTML;
            console.log(`üêõ ${message}`);
        }
        
        function showLocalStorage() {
            const data = {
                studentId: localStorage.getItem('studentId'),
                classId: localStorage.getItem('classId'),
                username: localStorage.getItem('username'),
                all: Object.keys(localStorage).map(key => `${key}: ${localStorage.getItem(key)}`)
            };
            
            alert('localStorage:\n' + JSON.stringify(data, null, 2));
            updateDebug('–ü–æ–∫–∞–∑–∞–Ω localStorage');
        }
        
        function clearAll() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –í–°–Å? –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                localStorage.clear();
                updateDebug('üßπ –í—Å—ë –æ—á–∏—â–µ–Ω–æ');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 500);
            }
        }
        
        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                localStorage.clear();
                updateDebug('üëã –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
                window.location.href = 'login.html';
            }
        }
        
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–°–ü–û–†–¢ ====================
        window.loadMarks = loadMarks;
        window.loadSubjects = loadSubjects;
        window.loadMessages = loadMessages;
        window.testProxy = testProxy;
        window.showLocalStorage = showLocalStorage;
        window.clearAll = clearAll;
        window.logout = logout;
    </script>
</body>
</html>
