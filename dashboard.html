<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫ - –®–∫–æ–ª–∞ 28</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --danger: #f72585;
            --warning: #f8961e;
            --gray-200: #e9ecef;
            --gray-600: #6c757d;
            --gray-800: #343a40;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }
        
        /* –®–∞–ø–∫–∞ */
        .header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--gray-800);
        }
        .user-info p {
            font-size: 14px;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logout-btn {
            background: var(--gray-200);
            border: none;
            color: var(--gray-800);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            background: #dee2e6;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-tabs {
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 32px;
            border: 1px solid var(--gray-200);
            overflow-x: auto;
        }
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:hover {
            background: #f8f9fa;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .tab-content h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--gray-800);
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
        .subject-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--gray-200);
            transition: border-color 0.2s;
        }
        .subject-card:hover {
            border-color: var(--primary);
        }
        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .subject-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }
        .teacher {
            font-size: 14px;
            color: var(--gray-600);
            background: #f8f9fa;
            padding: 4px 12px;
            border-radius: 20px;
        }
        .marks-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .mark {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            background: #e3f2fd;
            color: #1565c0;
        }
        .mark.bad {
            background: #ffebee;
            color: #c62828;
        }
        .mark.good {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .mark.neutral {
            background: #f5f5f5;
            color: #616161;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--gray-200);
            border-left: 4px solid var(--warning);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .message-date {
            font-size: 14px;
            color: var(--gray-600);
        }
        .message-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--gray-800);
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-600);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –û—à–∏–±–∫–∏ */
        .error-card {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin: 20px 0;
        }
        .error-card h3 {
            color: #c53030;
            margin-bottom: 8px;
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--gray-200);
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 6px;
                margin-bottom: 24px;
            }
            .tab-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="header-content">
            <div class="user-info">
                <h1 id="studentName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <p><span id="className">–ö–ª–∞—Å—Å: 8"–µ"</span> ‚Ä¢ <span id="schoolInfo">–®–∫–æ–ª–∞ ‚Ññ28, –ö–∏—Ä–æ–≤</span></p>
            </div>
            <button class="logout-btn" onclick="logout()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M6 12.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v1z"/>
                    <path d="M4.5 10a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-7z"/>
                    <path d="M8 1a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/>
                </svg>
                –í—ã–π—Ç–∏
            </button>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('marks')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
                –û—Ü–µ–Ω–∫–∏
            </button>
            <button class="tab-btn" onclick="showTab('subjects')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.892 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                </svg>
                –ü—Ä–µ–¥–º–µ—Ç—ã
            </button>
            <button class="tab-btn" onclick="showTab('messages')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
                </svg>
                –°–æ–æ–±—â–µ–Ω–∏—è
            </button>
            <button class="tab-btn" onclick="showTab('stats')">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
                </svg>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –û—Ü–µ–Ω–∫–∏ -->
        <div id="marksTab" class="tab-content active">
            <h2>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h2>
            <div id="marksContent" class="loading">
                <div class="loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –ü—Ä–µ–¥–º–µ—Ç—ã -->
        <div id="subjectsTab" class="tab-content">
            <h2>–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h2>
            <div id="subjectsContent" class="loading">
                <div class="loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messagesTab" class="tab-content">
            <h2>–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —É—á–∏—Ç–µ–ª–µ–π</h2>
            <div id="messagesContent" class="loading">
                <div class="loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="statsTab" class="tab-content">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏</h2>
            <div id="statsContent" class="loading">
                <div class="loading-spinner"></div>
                –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>
        
        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="debugInfo" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 12px; font-size: 14px; color: #6c757d; display: none;">
            <h3 style="margin-bottom: 12px; color: #495057;">–û—Ç–ª–∞–¥–∫–∞</h3>
            <div id="debugContent"></div>
            <button onclick="runTests()" style="margin-top: 12px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
            </button>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            debug: true,
            defaultStudentId: 4477,
            defaultClassId: 1000,
            currentYear: 2025
        };
        
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let userData = {
            studentId: null,
            classId: null,
            username: null,
            fullName: null
        };
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üì± Dashboard –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!checkAuth()) {
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É
            showTab('marks');
        });
        
        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        function checkAuth() {
            userData.studentId = localStorage.getItem('studentId');
            userData.classId = localStorage.getItem('classId');
            userData.username = localStorage.getItem('username');
            
            if (!userData.studentId || !userData.username) {
                console.warn('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω');
                window.location.href = 'login.html';
                return false;
            }
            
            console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫:', userData);
            return true;
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ====================
        async function loadUserData() {
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É
                document.getElementById('studentName').textContent = 
                    userData.username || '–£—á–µ–Ω–∏–∫';
                
                document.getElementById('className').textContent = 
                    `–ö–ª–∞—Å—Å: ${userData.classId || '8"–µ"'}`;
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                if (CONFIG.debug) {
                    document.getElementById('debugInfo').style.display = 'block';
                    updateDebugInfo();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }
        
        // ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
        function showTab(tabName) {
            console.log(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É: ${tabName}`);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            event.target.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            loadTabData(tabName);
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –í–ö–õ–ê–î–ö–ò ====================
        async function loadTabData(tabName) {
            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏: ${tabName}`);
            
            switch (tabName) {
                case 'marks':
                    await loadMarks();
                    break;
                case 'subjects':
                    await loadSubjects();
                    break;
                case 'messages':
                    await loadMessages();
                    break;
                case 'stats':
                    await loadStats();
                    break;
            }
        }
        
        // ==================== API –ó–ê–ü–†–û–°–´ ====================
        async function fetchAvers(action, params = {}) {
            console.group(`üì§ API –∑–∞–ø—Ä–æ—Å: ${action}`);
            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', params);
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const requestData = {
                    action: action,
                    student: parseInt(userData.studentId) || CONFIG.defaultStudentId,
                    uchYear: CONFIG.currentYear,
                    cls: parseInt(userData.classId) || CONFIG.defaultClassId,
                    ...params
                };
                
                console.log('–ü–æ–ª–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:', requestData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                console.groupEnd();
                
                return data;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞:', error);
                console.groupEnd();
                throw error;
            }
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –û–¶–ï–ù–û–ö ====================
        async function loadMarks() {
            const container = document.getElementById('marksContent');
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...
                    </div>
                `;
                
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...');
                const marks = await fetchAvers('GET_STUDENT_MARKS');
                
                if (!marks || marks.length === 0) {
                    container.innerHTML = `
                        <div class="error-card">
                            <h3>–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</h3>
                            <p>–û—Ü–µ–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p>
                        </div>
                    `;
                    return;
                }
                
                displayMarks(marks);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 12px; font-size: 14px;">
                            StudentId: ${userData.studentId}<br>
                            ClassId: ${userData.classId}
                        </p>
                    </div>
                `;
            }
        }
        
        // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –û–¶–ï–ù–û–ö ====================
        function displayMarks(marks) {
            const container = document.getElementById('marksContent');
            
            if (!marks || !Array.isArray(marks)) {
                container.innerHTML = '<div class="error-card">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            let html = '';
            
            marks.forEach((item, index) => {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                const marksHtml = item.marks_154 || item.marks_262 || '';
                const cleanMarks = extractMarks(marksHtml);
                
                // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const numericMarks = cleanMarks.filter(m => {
                    const num = parseFloat(m);
                    return !isNaN(num) && num >= 1 && num <= 5;
                }).map(m => parseFloat(m));
                
                const average = numericMarks.length > 0 
                    ? (numericMarks.reduce((a, b) => a + b) / numericMarks.length).toFixed(2)
                    : null;
                
                html += `
                    <div class="subject-card">
                        <div class="subject-header">
                            <div class="subject-name">${index + 1}. ${item.subject || '–ü—Ä–µ–¥–º–µ—Ç'}</div>
                            <div class="teacher">${item.teacher || '–£—á–∏—Ç–µ–ª—å'}</div>
                        </div>
                        
                        <div class="marks-list">
                            ${cleanMarks.map(mark => {
                                const num = parseFloat(mark);
                                let className = 'mark';
                                
                                if (mark.includes('/')) {
                                    className += ' good';
                                } else if (!isNaN(num)) {
                                    if (num >= 4.5) className += ' good';
                                    else if (num <= 2.5) className += ' bad';
                                    else className += ' neutral';
                                } else {
                                    className += ' neutral';
                                }
                                
                                return `<span class="${className}" title="${mark}">${mark}</span>`;
                            }).join('')}
                        </div>
                        
                        ${average ? `
                            <div style="margin-top: 12px; font-size: 14px; color: #6c757d;">
                                <strong>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:</strong> ${average}
                                <span style="margin-left: 12px;">
                                    <strong>–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫:</strong> ${numericMarks.length}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –ü–†–ï–î–ú–ï–¢–û–í ====================
        async function loadSubjects() {
            const container = document.getElementById('subjectsContent');
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...
                    </div>
                `;
                
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...');
                const subjects = await fetchAvers('GET_STUDENT_SUBJECTS');
                
                if (!subjects || subjects.length === 0) {
                    container.innerHTML = `
                        <div class="error-card">
                            <h3>–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                            <p>–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>
                    `;
                    return;
                }
                
                displaySubjects(subjects);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–û–í ====================
        function displaySubjects(subjects) {
            const container = document.getElementById('subjectsContent');
            
            if (!Array.isArray(subjects)) {
                container.innerHTML = '<div class="error-card">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            let html = '<div class="stats-grid">';
            let subjectCount = 0;
            
            subjects.forEach(subject => {
                if (Array.isArray(subject) && subject[1]) {
                    subjectCount++;
                    html += `
                        <div class="subject-card">
                            <div class="subject-name">${subject[1]}</div>
                            <div style="margin-top: 8px; font-size: 14px; color: #6c757d;">
                                ID: ${subject[0]}
                                ${subject[2] ? `<br>–ß–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é: ${subject[2]}` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            html = `
                <div class="stat-card" style="margin-bottom: 24px;">
                    <div class="stat-value">${subjectCount}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                </div>
                ${html}
            `;
            
            container.innerHTML = html;
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================
        async function loadMessages() {
            const container = document.getElementById('messagesContent');
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
                    </div>
                `;
                
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...');
                const messages = await fetchAvers('GET_STUDENT_MESSAGES');
                
                if (!messages || messages.length === 0) {
                    container.innerHTML = `
                        <div class="error-card">
                            <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —É—á–∏—Ç–µ–ª–µ–π</p>
                        </div>
                    `;
                    return;
                }
                
                displayMessages(messages);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ====================
        function displayMessages(messages) {
            const container = document.getElementById('messagesContent');
            
            if (!Array.isArray(messages)) {
                container.innerHTML = '<div class="error-card">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            let html = '';
            
            messages.forEach((msg, index) => {
                const date = msg.dateWhen ? new Date(msg.dateWhen).toLocaleDateString('ru-RU') : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞';
                
                html += `
                    <div class="message-card">
                        <div class="message-header">
                            <div class="message-date">${date}</div>
                            ${msg.subjectId ? `<div class="teacher">–ü—Ä–µ–¥–º–µ—Ç ID: ${msg.subjectId}</div>` : ''}
                        </div>
                        <div class="message-text">${msg.message || '–°–æ–æ–±—â–µ–Ω–∏–µ'}</div>
                        ${msg.status ? `<div style="margin-top: 8px; font-size: 12px; color: #6c757d;">–°—Ç–∞—Ç—É—Å: ${msg.status}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
        async function loadStats() {
            const container = document.getElementById('statsContent');
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...
                    </div>
                `;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                const marks = await fetchAvers('GET_STUDENT_MARKS');
                
                if (!marks || marks.length === 0) {
                    container.innerHTML = `
                        <div class="error-card">
                            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ü–µ–Ω–∫–∏ —Å–Ω–∞—á–∞–ª–∞</p>
                        </div>
                    `;
                    return;
                }
                
                displayStats(marks);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h3>–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
        function displayStats(marks) {
            const container = document.getElementById('statsContent');
            
            // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let totalMarks = 0;
            let totalSubjects = marks.length;
            let marksBySubject = [];
            
            marks.forEach(item => {
                const marksHtml = item.marks_154 || item.marks_262 || '';
                const cleanMarks = extractMarks(marksHtml);
                const numericMarks = cleanMarks.filter(m => {
                    const num = parseFloat(m);
                    return !isNaN(num) && num >= 1 && num <= 5;
                }).map(m => parseFloat(m));
                
                totalMarks += numericMarks.length;
                
                if (numericMarks.length > 0) {
                    const average = numericMarks.reduce((a, b) => a + b) / numericMarks.length;
                    marksBySubject.push({
                        subject: item.subject || '–ü—Ä–µ–¥–º–µ—Ç',
                        average: average.toFixed(2),
                        count: numericMarks.length,
                        best: Math.max(...numericMarks),
                        worst: Math.min(...numericMarks)
                    });
                }
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É
            marksBySubject.sort((a, b) => b.average - a.average);
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalSubjects}</div>
                        <div class="stat-label">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalMarks}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${marksBySubject.length > 0 ? marksBySubject[0].subject : '-'}</div>
                        <div class="stat-label">–õ—É—á—à–∏–π –ø—Ä–µ–¥–º–µ—Ç</div>
                    </div>
                </div>
            `;
            
            // –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            if (marksBySubject.length > 0) {
                html += `
                    <div style="margin-top: 32px;">
                        <h3 style="margin-bottom: 16px;">–†–µ–π—Ç–∏–Ω–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                        <div style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e9ecef;">
                `;
                
                marksBySubject.forEach((subject, index) => {
                    html += `
                        <div style="display: flex; align-items: center; padding: 16px; border-bottom: ${index < marksBySubject.length - 1 ? '1px solid #e9ecef' : 'none'};">
                            <div style="width: 32px; font-weight: 600; color: #6c757d;">${index + 1}</div>
                            <div style="flex: 1;">${subject.subject}</div>
                            <div style="font-weight: 600; color: #4361ee;">${subject.average}</div>
                            <div style="margin-left: 24px; font-size: 14px; color: #6c757d;">
                                ${subject.count} –æ—Ü–µ–Ω–æ–∫
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function extractMarks(htmlString) {
            if (!htmlString) return [];
            
            return htmlString
                .replace(/<[^>]*>/g, '')
                .replace(/&nbsp;/g, ' ')
                .replace(/\([^)]*\)/g, '') // –£–±–∏—Ä–∞–µ–º (3.98) –∏ —Ç.–¥.
                .trim()
                .split(/\s+/)
                .filter(m => m && m.length < 4 && m !== '...' && !m.includes('span'))
                .map(m => m.replace(/[^0-9./–£–ë–ù]/g, ''));
        }
        
        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            
            debugContent.innerHTML = `
                <div style="font-family: monospace; font-size: 13px;">
                    <div><strong>StudentId:</strong> ${userData.studentId}</div>
                    <div><strong>ClassId:</strong> ${userData.classId}</div>
                    <div><strong>Username:</strong> ${userData.username}</div>
                    <div><strong>–ì–æ–¥:</strong> ${CONFIG.currentYear}</div>
                    <div><strong>API Endpoint:</strong> ${window.location.origin}/api/proxy</div>
                </div>
            `;
        }
        
        async function runTests() {
            console.group('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤');
            
            try {
                // –¢–µ—Å—Ç 1: Ping API
                console.log('–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ API...');
                const pingResponse = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'ping' })
                });
                console.log('Ping —Å—Ç–∞—Ç—É—Å:', pingResponse.status);
                
                // –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                console.log('–¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–¥–º–µ—Ç–æ–≤...');
                const subjects = await fetchAvers('GET_STUDENT_SUBJECTS');
                console.log('–ü—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ:', subjects ? subjects.length : 0);
                
                alert(`–¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!\nPing: ${pingResponse.status}\n–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${subjects ? subjects.length : 0}`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤:', error);
                alert('–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å: ' + error.message);
            }
            
            console.groupEnd();
        }
        
        // ==================== –í–´–•–û–î ====================
        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
        
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–°–ü–û–†–¢ ====================
        window.runTests = runTests;
        window.showTab = showTab;
        window.logout = logout;
    </script>
</body>
</html>
