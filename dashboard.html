<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            cursor: pointer;
        }
        .card { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        .loading { color: gray; font-style: italic; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üìö –ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫</h1>
    
    <div id="userInfo" class="card">
        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
    </div>
    
    <div>
        <button onclick="loadMarks()">–ó–ê–ì–†–£–ó–ò–¢–¨ –û–¶–ï–ù–ö–ò</button>
        <button onclick="loadSubjects()">–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–†–ï–î–ú–ï–¢–´</button>
        <button onclick="logout()">–í–´–ô–¢–ò</button>
    </div>
    
    <div id="marksContent" class="card">
        –ù–∞–∂–º–∏ "–ó–ê–ì–†–£–ó–ò–¢–¨ –û–¶–ï–ù–ö–ò"
    </div>
    
    <div id="subjectsContent" class="card">
        –ù–∞–∂–º–∏ "–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–†–ï–î–ú–ï–¢–´"
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥
        window.onload = function() {
            const studentId = localStorage.getItem('studentId');
            const username = localStorage.getItem('username');
            const cookies = localStorage.getItem('cookies');
            
            if (!studentId || !username || !cookies) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!");
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userInfo').innerHTML = `
                –£—á–µ–Ω–∏–∫: <strong>${username}</strong><br>
                ID: <strong>${studentId}</strong><br>
                –ö–ª–∞—Å—Å: <strong>${localStorage.getItem('classId') || '1000'}</strong><br>
                –ö—É–∫–∏: <strong>${cookies ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</strong>
            `;
        };
        
        async function loadMarks() {
            const container = document.getElementById('marksContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...</span>';
            
            try {
                const studentId = localStorage.getItem('studentId');
                const classId = localStorage.getItem('classId');
                const cookies = localStorage.getItem('cookies');
                
                console.log('–ó–∞–≥—Ä—É–∂–∞—é –æ—Ü–µ–Ω–∫–∏ —Å –∫—É–∫–∞–º–∏:', cookies ? '–ï—Å—Ç—å' : '–ù–µ—Ç');
                
                // –ó–∞–ø—Ä–æ—Å —Å –∫—É–∫–∞–º–∏
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'GET_STUDENT_MARKS',
                        student: parseInt(studentId),
                        uchYear: 2025,
                        cls: parseInt(classId),
                        _cookies: cookies // –í–ê–ñ–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—É–∫–∏
                    })
                });
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç –æ—Ç API:', data);
                
                if (!data.success) {
                    container.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
                    return;
                }
                
                const marks = data.data || [];
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ—Ü–µ–Ω–æ–∫:', marks.length);
                
                if (marks.length === 0) {
                    container.innerHTML = '<span class="error">‚ùå –ù–µ—Ç –æ—Ü–µ–Ω–æ–∫ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>';
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫–∏
                let html = "<h3>üìä –û—Ü–µ–Ω–∫–∏:</h3>";
                marks.forEach(item => {
                    const marksText = item.marks_154 || item.marks_262 || '–Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫';
                    html += `<div><strong>${item.subject || '–ü—Ä–µ–¥–º–µ—Ç'}</strong>: ${marksText}</div>`;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫:', error);
                container.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        async function loadSubjects() {
            const container = document.getElementById('subjectsContent');
            container.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤...</span>';
            
            try {
                const studentId = localStorage.getItem('studentId');
                const classId = localStorage.getItem('classId');
                const cookies = localStorage.getItem('cookies');
                
                console.log('–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–µ–¥–º–µ—Ç—ã —Å –∫—É–∫–∞–º–∏:', cookies ? '–ï—Å—Ç—å' : '–ù–µ—Ç');
                
                // –ó–∞–ø—Ä–æ—Å —Å –∫—É–∫–∞–º–∏
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'GET_STUDENT_SUBJECTS',
                        student: parseInt(studentId),
                        uchYear: 2025,
                        cls: parseInt(classId),
                        _cookies: cookies // –í–ê–ñ–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—É–∫–∏
                    })
                });
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç –æ—Ç API:', data);
                
                if (!data.success) {
                    container.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
                    return;
                }
                
                const subjects = data.data || [];
                console.log('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', subjects.length);
                
                if (subjects.length === 0) {
                    container.innerHTML = '<span class="error">‚ùå –ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>';
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
                let html = "<h3>üìö –ü—Ä–µ–¥–º–µ—Ç—ã:</h3>";
                subjects.forEach(subject => {
                    if (Array.isArray(subject) && subject[1]) {
                        html += `<div>${subject[1]}</div>`;
                    }
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', error);
                container.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
            }
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Å–æ–ª—å –ø–æ Ctrl+Shift+I
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                console.log('–û—Ç–∫—Ä—ã–≤–∞—é –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏...');
                console.log('localStorage:', {
                    studentId: localStorage.getItem('studentId'),
                    classId: localStorage.getItem('classId'),
                    username: localStorage.getItem('username'),
                    cookies: localStorage.getItem('cookies') ? '–ï—Å—Ç—å' : '–ù–µ—Ç'
                });
            }
        });
    </script>
</body>
</html>
